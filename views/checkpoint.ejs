<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkpoint <%= checkpoint %></title>
    <style>
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes progress {
            from { width: 0%; }
            to { width: 100%; }
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        body{
            font-family:'Segoe UI',Arial,sans-serif;
            background:linear-gradient(-45deg,#4facfe,#00f2fe,#43e97b,#f9f047);
            background-size:400% 400%;animation:gradient 15s ease infinite;
            display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;
        }
        .container{background:rgba(255,255,255,0.9);backdrop-filter:blur(5px);border-radius:12px;padding:32px;width:100%;max-width:420px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.1);} 
        h1{color:#222;margin-bottom:12px;font-weight:600;}
        .checkpoint-number{font-size:3.4em;color:#4CAF50;margin:10px 0;font-weight:bold;}
        p{color:#555;margin-bottom:20px;}
        .progress{width:100%;height:28px;background:#e0e0e0;border-radius:14px;overflow:hidden;margin:20px 0;}
        .progress-bar{height:100%;background:linear-gradient(90deg,#4CAF50,#45a049);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;animation:progress 1s forwards;}
        .btn{background:#4CAF50;color:#fff;border:none;padding:14px 28px;font-size:16px;border-radius:8px;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 2px 8px rgba(0,0,0,0.15);} 
        .btn:hover{transform:translateY(-3px);box-shadow:0 4px 12px rgba(0,0,0,0.2);} 
        .btn:active{transform:scale(.97);} 
        .btn.disabled{opacity:0.5;pointer-events:none;filter:grayscale(1);cursor:not-allowed !important;}  
        .loading-overlay{position:fixed;top:20px;right:20px;background:#333;color:#fff;padding:12px 20px;border-radius:8px;opacity:0;pointer-events:none;transition:opacity .3s;z-index:1000;}
        .loading-overlay.show{opacity:1;}
        .page-loader{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,0.6);color:#fff;font-size:2rem;font-weight:600;z-index:2000;transition:opacity .3s;}
        .service-picker{background:#f6f8fb;border:1px solid #e2e6ef;border-radius:12px;padding:14px;margin:10px 0 6px;}
        .service-picker.hidden{display:none;}
        .service-picker h3{margin:0 0 8px;font-size:15px;color:#333;font-weight:600;}
        .service-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;}
        .service-card{border:1px solid #d6deeb;border-radius:10px;padding:12px;cursor:pointer;transition:all .2s;background:#fff;display:flex;align-items:center;gap:10px;justify-content:center;font-weight:600;color:#1f2d3d;}
        .service-card:hover{box-shadow:0 6px 14px rgba(0,0,0,0.08);transform:translateY(-2px);}
        .service-card.active{border-color:#4CAF50;background:linear-gradient(135deg,rgba(76,175,80,0.12),rgba(76,175,80,0.05));box-shadow:0 8px 18px rgba(76,175,80,0.2);}
        @media(max-width:500px){.container{padding:24px}.btn{width:100%;margin-top:10px}}
    </style>
</head>
<body>
    <div id="pageLoader" class="page-loader">Loading...</div>
    <div class="container" data-hwid="<%= hwid %>" data-rid="<%= rid %>" data-base="<%= baseUrl %>" data-cp="<%= checkpoint %>" data-max="<%= maxCheckpoint %>" data-service="<%= service %>">
        <% if (checkpoint === 0) { %>
          <h1>Select a Service</h1>
        <% } else { %>
          <h1>Checkpoint <%= checkpoint %></h1>
          <div class="checkpoint-number"><%= checkpoint %>/<%= maxCheckpoint %></div>
          <div class="progress">
              <div class="progress-bar" data-progress="<%= Math.round((checkpoint / maxCheckpoint) * 100) %>" style="width:0%"><span class="progress-text"><%= Math.round((checkpoint / maxCheckpoint) * 100) %>%</span></div>
          </div>
  <div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:3000;">
    <div style="background:#0f172a;border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:18px 20px;max-width:320px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.45);">
      <h3 style="margin:0 0 8px;font-size:18px;color:#fff;">Warning</h3>
      <p style="margin:0 0 14px;color:#e5e7eb;font-size:14px;">If you change services, your progress will be reset.</p>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="modal-cancel" class="btn-ghost" style="padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.04);color:#e5e7eb;cursor:pointer;">Cancel</button>
        <button id="modal-continue" class="btn" style="padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(135deg,#f97316,#fb7185);color:#0b0f19;font-weight:700;cursor:pointer;">Continue</button>
      </div>
    </div>
  </div>
          <p>Complete the task to proceed</p>
          <div style="margin:20px 0;" class="h-captcha" data-sitekey="6b8ab476-90dc-44f4-9c92-c78c90e422c0" data-callback="onCaptcha"></div>
        <% } %>
        <div id="servicePicker" class="service-picker <%= checkpoint === 0 ? '' : 'hidden' %>" style="margin-top:12px;">
          <h3>Select a service</h3>
          <div class="service-options">
            <div class="service-card <%= service === 'linkvertise' ? 'active' : '' %>" data-service="linkvertise">LinkVertise</div>
            <div class="service-card <%= service === 'lootlabs' ? 'active' : '' %>" data-service="lootlabs">LootLabs</div>
          </div>
          <% if (checkpoint === 0) { %>
            <p style="margin-top:14px;">Choose your preferred service to start the checkpoints.</p>
          <% } else { %>
            <p style="margin-top:10px;font-size:13px;color:#666;">Switching service won't reset your progress.</p>
          <% } %>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:13px;color:#444;">
          <span id="serviceLabel">Service: <%= (service || 'linkvertise').charAt(0).toUpperCase() + (service || 'linkvertise').slice(1) %></span>
          <button id="switchService" class="btn btn-ghost" style="padding:8px 12px;font-size:12px;background:#e7f1ff;color:#0b3b8c;border:1px solid #c6dafc;">Switch Service</button>
        </div>
        <a href="#" class="btn btn-continue disabled" aria-disabled="true">Continue</a>
    </div>
    <div id="toastLoader" class="loading-overlay"><span>Generating Link...</span></div>
    <div id="fullLoader" style="position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.7);color:#fff;font-size:2rem;font-weight:700;z-index:1500;">Loading...</div>
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <script>
      const KEY = '__x_cp_token';
      const container = document.querySelector('.container');
      const hwid = container?.dataset?.hwid || '';
      const rid = container?.dataset?.rid || '';
      const baseUrl = (container?.dataset?.base || '').replace(/\/+$/, '');
      const cpValue = Number(container?.dataset?.cp || '0');
      const maxCp = Number(container?.dataset?.max || '1');
      const urlParams = new URLSearchParams(window.location.search || '');
      const serviceParam = urlParams.get('service') || (container?.dataset?.service || '');
      const STORAGE_KEY = '__jx_saved_key_' + (hwid || '').replace(/[^a-zA-Z0-9_-]/g,'');
      function saveToken(c){
        try{
          const payload = { h: hwid, c, t: Date.now() };
          localStorage.setItem(KEY, btoa(JSON.stringify(payload)));
        }catch(e){}
      }
      function readToken(){
        try{
          const raw = localStorage.getItem(KEY);
          if(!raw) return null;
          return JSON.parse(atob(raw));
        }catch(e){ return null; }
      }
      function resetFlow(){
        try{ localStorage.removeItem(KEY); }catch(e){}
        const ridPart = rid ? '&rid=' + encodeURIComponent(rid) : '';
        window.location.href = '/checkpoint?hwid=' + encodeURIComponent(hwid) + ridPart + '&reset=1';
      }
      (async function restoreSavedKey(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return;
          const data = JSON.parse(raw);
          if(!data || !data.key){ localStorage.removeItem(STORAGE_KEY); return; }
          // Ensure key still valid server-side
          const verifyRes = await fetch((baseUrl || '') + '/api/jx/keys/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hwid, key: data.key })
          });
          const verifyData = await verifyRes.json();
          if(verifyData && verifyData.ok && verifyData.valid){
            if(!data.expiresAt || Date.now() < data.expiresAt){
              const ridPart = rid ? '&rid=' + encodeURIComponent(rid) : '';
              const nextUrlBase = baseUrl || '';
              window.location.href = `${nextUrlBase}/reward?hwid=${encodeURIComponent(hwid)}${ridPart}`;
              return;
            }
          }
          localStorage.removeItem(STORAGE_KEY);
        }catch(e){ localStorage.removeItem(STORAGE_KEY); }
      })();
      (function bootstrapGuard(){
        if(cpValue === 0) return;
        const token = readToken();
        if(cpValue === 1){
          // First checkpoint: allow entry even if no prior token; set baseline
          if(!token || token.h !== hwid){
            saveToken(0);
          }
          return;
        }
        // For cp >=2 require previous checkpoint token
        if(!token || token.h !== hwid || typeof token.c === 'undefined' || token.c < cpValue - 1){
          resetFlow();
          return;
        }
        if(token.c < cpValue){
          saveToken(cpValue);
        }
      })();

      const pageStart = Date.now();
      let selectedService = (serviceParam || 'linkvertise').toLowerCase() === 'lootlabs' ? 'lootlabs' : 'linkvertise';
      function onCaptcha(token){
        const elapsed = Date.now() - pageStart;
        if(elapsed < 3000){
          window.location.href = '/bypass?hwid=<%= encodeURIComponent(hwid) %>';
          return;
        }
        const btn = document.querySelector('.btn-continue');
        btn.classList.remove('disabled');
        btn.removeAttribute('aria-disabled');
      }

      document.addEventListener('DOMContentLoaded', () => {
        const toast = document.getElementById('toastLoader');
        const full = document.getElementById('fullLoader');
        const btn = document.querySelector('.btn-continue');
        const bar = document.querySelector('.progress-bar');
        const serviceCards = document.querySelectorAll('.service-card');
        const serviceLabel = document.getElementById('serviceLabel');
        const switchBtn = document.getElementById('switchService');
        const servicePicker = document.getElementById('servicePicker');
        const modal = document.getElementById('modal');
        const modalCancel = document.getElementById('modal-cancel');
        const modalContinue = document.getElementById('modal-continue');
        function showModal(){ if(modal){ modal.style.display='flex'; } }
        function hideModal(){ if(modal){ modal.style.display='none'; } }
        function resetToServiceSelect(){
          const ridPart = rid ? `&rid=${encodeURIComponent(rid)}` : '';
          const nextUrlBase = baseUrl || '';
          window.location.href = `${nextUrlBase}/checkpoint?hwid=${encodeURIComponent(hwid)}${ridPart}&cp=0&reset=1`;
        }
        if(modalCancel) modalCancel.addEventListener('click', hideModal);
        if(modalContinue) modalContinue.addEventListener('click', resetToServiceSelect);
        if(serviceCards.length){
          // Sync preselected service if present in URL
          serviceCards.forEach(card=>{
            if(card.dataset.service === selectedService){
              card.classList.add('active');
            }else{
              card.classList.remove('active');
            }
          });
        if(serviceLabel){
          serviceLabel.textContent = 'Service: ' + selectedService.charAt(0).toUpperCase() + selectedService.slice(1);
        }
        if(switchBtn){
          switchBtn.addEventListener('click', (e)=>{
            if(cpValue > 0){
              e.preventDefault();
              showModal();
              return;
            }
            if(servicePicker){
              servicePicker.classList.toggle('hidden');
            }
            selectedService = selectedService === 'linkvertise' ? 'lootlabs' : 'linkvertise';
            if(serviceCards.length){
              serviceCards.forEach(c=>{
                c.classList.toggle('active', c.dataset.service === selectedService);
              });
            }
            if(serviceLabel){
              serviceLabel.textContent = 'Service: ' + selectedService.charAt(0).toUpperCase() + selectedService.slice(1);
            }
          });
        }
          serviceCards.forEach(card=>{
            card.addEventListener('click', (e)=>{
              if(cpValue > 0){
                e.preventDefault();
                showModal();
                return;
              }
              serviceCards.forEach(c=>c.classList.remove('active'));
              card.classList.add('active');
              selectedService = card.dataset.service || 'linkvertise';
            });
          });
        }
        const target = Number(bar?.dataset?.progress || 0);
        requestAnimationFrame(()=>{
          if(bar){
            bar.style.transition = 'width .6s ease';
            bar.style.width = `${target}%`;
            const txt = bar.querySelector('.progress-text');
            if(txt) txt.textContent = `${target}%`;
          }
        });
        // On service selection step (cp 0), enable continue immediately (no captcha here)
        if(cpValue === 0){
          btn.classList.remove('disabled');
          btn.removeAttribute('aria-disabled');
        }
        btn.addEventListener('click', (e) => {
          if(btn.classList.contains('disabled')){ e.preventDefault(); return; }
          e.preventDefault();
          if(cpValue > 0){
            saveToken(cpValue);
          }
          full.style.display='flex';
          toast.classList.add('show');
          const nextUrlBase = baseUrl || '';
          let url;
          if(cpValue === 0){
            // move into first checkpoint after picking service
            url = `${nextUrlBase}/checkpoint?hwid=${encodeURIComponent(hwid)}${rid ? `&rid=${encodeURIComponent(rid)}` : ''}&cp=1&service=${encodeURIComponent(selectedService)}`;
          }else{
            // send to external task for current checkpoint
            url = `${nextUrlBase}/goto?hwid=${encodeURIComponent(hwid)}${rid ? `&rid=${encodeURIComponent(rid)}` : ''}&checkpoint=${cpValue}&service=${encodeURIComponent(selectedService)}`;
          }
          setTimeout(()=>{ window.location.href = url; },2000);
        });
        const pl = document.getElementById('pageLoader');
        setTimeout(()=>{ if(pl){pl.style.opacity='0';pl.style.pointerEvents='none';}},2000);
      });
    </script>
</body>
</html>
